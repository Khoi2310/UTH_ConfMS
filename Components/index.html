<!DOCTYPE html>
<html lang="vi" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard Application - Quản lý và theo dõi hệ thống">
    <title>Dashboard - Main App</title>
    
    <link rel="stylesheet" href="../Css/index.css">
</head>

<body>

    <div class="app">
        <div class="layout">

            <!-- SIDEBAR -->
            <iframe id="sidebarFrame" src="./Layout/sidebar.html" class="sidebar-frame">
            </iframe>

            <!-- MAIN -->
            <div class="main">

                <!-- HEADER -->
                <iframe id="headerFrame" src="./Layout/header.html" class="header-frame">
                </iframe>

                <!-- CONTENT -->
                <main>
                    <div class="content-wrapper">
                        <div class="page-header">
                            <h2>Dashboard</h2>
                            <p class="page-description">Tổng quan và thống kê hệ thống</p>
                        </div>
                        <div class="content-placeholder">
                            <p>Nội dung chính hiển thị tại đây</p>
                        </div>
                    </div>
                </main>

            </div>
        </div>
    </div>

    <script>
        /* ================= GLOBAL STATE MANAGEMENT ================= */
        const AppState = {
            darkMode: localStorage.getItem('darkMode') === 'true' || false,
            sidebarCollapsed: localStorage.getItem('sidebarCollapsed') === 'true' || false,
            
            init() {
                // Apply saved state
                if (this.darkMode) {
                    document.documentElement.classList.add('dark');
                }
                if (this.sidebarCollapsed) {
                    document.getElementById('sidebarFrame')?.classList.add('collapsed');
                }
                
                // Sync with iframes after they load
                this.syncAll();
            },
            
            save() {
                localStorage.setItem('darkMode', this.darkMode);
                localStorage.setItem('sidebarCollapsed', this.sidebarCollapsed);
            },
            
            syncAll() {
                // Wait for iframes to load
                setTimeout(() => {
                    this.broadcast({
                        type: 'SYNC_DARK',
                        payload: this.darkMode
                    });
                }, 100);
            }
        };

        /* ================= MESSAGE HANDLER ================= */
        window.addEventListener('message', (event) => {
            const { type, payload } = event.data || {};

            switch (type) {
                case 'TOGGLE_DARK':
                    AppState.toggleDarkMode();
                    break;

                case 'TOGGLE_SIDEBAR':
                    AppState.toggleSidebar();
                    break;
                    
                case 'IFRAME_READY':
                    // Iframe is ready, sync state
                    AppState.syncAll();
                    break;
            }
        });

        /* ================= ACTIONS ================= */
        AppState.toggleDarkMode = function() {
            this.darkMode = !this.darkMode;
            document.documentElement.classList.toggle('dark', this.darkMode);
            this.broadcast({
                type: 'SYNC_DARK',
                payload: this.darkMode
            });
            this.save();
        };

        AppState.toggleSidebar = function() {
            this.sidebarCollapsed = !this.sidebarCollapsed;
            const sidebarFrame = document.getElementById('sidebarFrame');
            if (sidebarFrame) {
                sidebarFrame.classList.toggle('collapsed', this.sidebarCollapsed);
            }
            this.save();
        };

        /* ================= BROADCAST UTILITY ================= */
        AppState.broadcast = function(message) {
            const headerFrame = document.getElementById('headerFrame');
            const sidebarFrame = document.getElementById('sidebarFrame');
            
            [headerFrame, sidebarFrame].forEach(frame => {
                try {
                    frame?.contentWindow?.postMessage(message, '*');
                } catch (e) {
                    console.warn('Failed to post message to iframe:', e);
                }
            });
        };

        /* ================= INITIALIZE APP ================= */
        document.addEventListener('DOMContentLoaded', () => {
            AppState.init();
        });

        // Fallback initialization
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', AppState.init);
        } else {
            AppState.init();
        }
    </script>

</body>

</html>